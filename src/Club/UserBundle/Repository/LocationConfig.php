<?php

namespace Club\UserBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * LocationConfig
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class LocationConfig extends EntityRepository
{
  public function getByKey($key, \Club\UserBundle\Entity\Location $location = null)
  {
    if ($location == null)
      $location = $this->_em->find('ClubUserBundle:Location',1);

    $config = $this->_em->createQueryBuilder()
      ->select('lc')
      ->from('ClubUserBundle:LocationConfig','lc')
      ->where('lc.location = :location')
      ->andWhere('lc.config = :key')
      ->setParameter('key',$key)
      ->setParameter('location',$location->getId())
      ->getQuery()
      ->getResult();

    if (!count($config)) {
      $config = $this->getByKey($key, $location->getLocation());

      if (count($config)) {
        return $config;
      } else {
        $config = $this->getByKey($key, $location->getLocation());

        if (count($config)) {
          return $config;
        } else {
          // TODO, find a way to make an infinitive loop
          throw new \Exception('Too many parents');
        }

      }
    }

    return $config[0];
  }

  public function getValueByKey($key, \Club\UserBundle\Entity\Location $location = null)
  {
    $config = $this->getByKey($key,$location);
    return $config->getValue();
  }
}
